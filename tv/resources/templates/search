<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml"
xmlns:t="http://www.participatorypolitics.org/"
xmlns:i18n="http://www.participatoryculture.org/i18n"
eventCookie="@@@eventCookie@@@" dtvPlatform="@@@dtvPlatform@@@">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <link href="resource:css/main.css" rel="stylesheet" type="text/css" />
  <t:include filename="dynamic.js" />
  <script type="text/javascript" src="resource:templates/search.js" />
  <script type="text/javascript" src="resource:templates/osxdnd.js" />

<t:execOnLoad><![CDATA[
#print templateState
from miro import searchengines
searchFeed = views.feeds.filterWithIndex(indexes.feedsByURL, 'dtv:search')
feed = searchFeed[0]

searchItems = views.items.filterWithIndex(indexes.itemsByFeed, feed.getID())
searchItemsSorted = searchItems.sort(sorts.itemSortSearch.sort, resort=True)
searchEngines = views.searchEngines

def setSortBy(by, section, handle):
  sorts.itemSortSearch.setSortBy(by)
  searchItems.recomputeSort(searchItemsSorted)
  handle.forceUpdate()
]]>
</t:execOnLoad>
<t:execOnUnLoad><![CDATA[
searchFeed.unlink()
searchItems.unlink()
]]>
</t:execOnUnLoad>

</head>

<body onkeydown="sendKeyToSearchBox(event);">
  <div id="main-titlebar">
    <div id="main-icon" class="noborder static-tab"><img src="resource:images/icon-search_large.png" /></div>
    <h1 id="main-title" class="static-tab" i18n:translate="">Video Search</h1>
    <div t:updateForView="searchFeed">
      <div id="engine-search">
        <form name="search" onsubmit="return performSearch();">
          <t:staticReplaceMarkup t:replaceData="searchengines.getSearchEnginesHTML()"/>
          <input id="search-box" type="search" name="query" value="***feed.quoteLastQuery()***" onKeyUp="return fillSearch();" onKeyPress="return validateSearch(event);" />
          <input type="submit" value="***_('Search')***" />      
        </form>
      </div>
    </div>
  </div>

  <div id="main-container" class="search">

    <div t:updateForView="searchItemsSorted">
      <div t:hideIf="searchItemsSorted.len() == 0">
        <t:executeTemplate filename="static-tab-sort-bar" 
        itemSort="sorts.itemSortSearch"
        section="'main'" />
      </div>
    </div>

    <div t:updateForView="searchFeed">
      <div class="search-message" t:showIf="feed.getStatus() == 'idle-empty'">
        <span i18n:translate="">No videos found.<br />Enter a query in the search field above.</span>
      </div>
      <div class="search-message" t:showIf="feed.getStatus() == 'searching'">
        <span i18n:translate="">Searching...</span>
      </div>
      <div class="search-message" t:showIf="feed.getStatus() == 'idle-no-results'">
        <span i18n:translate="">No matching videos found.<br />Enter a different query in the search field above.</span>
      </div>
      <div class="search-results-bar" t:showIf="feed.getStatus() == 'idle-with-results'">
        <div id="results-text" i18n:translate="">
          Results for "<span i18n:name="query" t:replace="feed.lastQuery" />"
        </div>
        <div class="save-search-searchpage">
          <a class="button gray" href="#" onclick="return eventURL('action:addEngineSearchFeed?term=@@@feed.lastQuery@@@&amp;name=@@@feed.lastEngine@@@');">
            <span i18n:translate="">Save as a Channel</span>
          </a>
        </div>
      </div>
    </div>

    <div id="search-results">
      <div t:repeatForView="searchItemsSorted" t:repeatTemplate="download-item" t:containerDiv="true" />
    </div>
  </div>
  
</body>

</html>
